name: Test Ozon API Live

on:
  workflow_dispatch:  # Manual trigger only - safe!

jobs:
  test-api:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'
      
      - name: Install dependencies
        run: pip install requests
      
      - name: Test Ozon API Connection
        env:
          OZON_CLIENT_ID: ${{ secrets.OZON_CLIENT_ID }}
          OZON_API_KEY: ${{ secrets.OZON_API_KEY }}
        run: |
          python - <<'EOF'
          import requests
          import os
          import json
          from datetime import datetime, timedelta
          
          client_id = os.environ.get('OZON_CLIENT_ID')
          api_key = os.environ.get('OZON_API_KEY')
          
          print("ğŸ” Testing Ozon API Connection")
          print("="*50)
          
          headers = {
              'Client-Id': client_id,
              'Api-Key': api_key,
              'Content-Type': 'application/json'
          }
          
          # Test 1: FBS Orders + Financials (Posting FBS RO)
          print("\nğŸ“¦ Testing FBS Orders with Financials...")
          payload = {
              "dir": "ASC",
              "filter": {
                  "since": (datetime.now() - timedelta(days=7)).isoformat()
              },
              "limit": 5,
              "with": {
                  "analytics_data": True,
                  "financial_data": True
              }
          }
          
          response = requests.post(
              'https://api.ozon.ru/v3/posting/fbs/list',
              headers=headers,
              json=payload
          )
          
          if response.status_code == 200:
              data = response.json()
              print(f"âœ… SUCCESS! Found {len(data.get('result', []))} FBS orders")
              
              # Show sample financial data if available
              if data.get('result') and len(data['result']) > 0:
                  first = data['result'][0]
                  if 'financial_data' in first:
                      print("   Sample financial data:")
                      print(f"   - Products price: {first['financial_data'].get('products_price', 'N/A')}")
                      print(f"   - Commission: {first['financial_data'].get('commission', 'N/A')}")
                      print(f"   - Delivery cost: {first['financial_data'].get('delivery_charge', 'N/A')}")
          else:
              print(f"âŒ Failed: {response.status_code}")
              print(response.text[:200])
          
          # Test 2: FBO Orders (Supply Order RO)
          print("\nğŸ“¦ Testing FBO Orders...")
          payload = {
              "filter": {
                  "since": (datetime.now() - timedelta(days=7)).isoformat()
              },
              "limit": 5
          }
          
          response = requests.post(
              'https://api.ozon.ru/v3/supply-order/list',
              headers=headers,
              json=payload
          )
          
          if response.status_code == 200:
              data = response.json()
              print(f"âœ… SUCCESS! Found {len(data.get('result', []))} FBO orders")
          else:
              print(f"âŒ Failed: {response.status_code}")
          
          # Test 3: Returns
          print("\nğŸ”„ Testing Returns...")
          payload = {
              "filter": {
                  "last_id": 0,
                  "limit": 5
              }
          }
          
          response = requests.post(
              'https://api.ozon.ru/v1/returns/list',
              headers=headers,
              json=payload
          )
          
          if response.status_code == 200:
              data = response.json()
              print(f"âœ… SUCCESS! Found {len(data.get('returns', []))} returns")
          else:
              print(f"âŒ Failed: {response.status_code}")
          
          print("\nğŸ¯ Test complete!")
          EOF
