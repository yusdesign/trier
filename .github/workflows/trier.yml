name: TRIER Unified Workflow

on:
  schedule:
    - cron: '*/30 * * * *'  # Every 30 minutes
  workflow_dispatch:  # Manual trigger

jobs:
  trier:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'
      
      - name: Install dependencies
        run: |
          pip install requests pandas numpy
      
      - name: Prepare directories
        run: |
          mkdir -p real_data/ozon
          mkdir -p data
          mkdir -p music
          mkdir -p docs
          # Initialize OZON metrics if not exists
          if [ ! -f real_data/ozon/ozon_metrics.json ]; then
            echo '{"last_update":null,"total_orders_24h":0,"fraud_alerts_24h":0,"amount_at_risk":0,"detection_rate":0.94,"precision":0.87,"scopes":{"fbs":{"orders":0,"fraud":0},"fbo":{"orders":0,"fraud":0},"returns":{"count":0,"abuse":0},"cancels":{"count":0,"suspicious":0}}}' > real_data/ozon/ozon_metrics.json
          fi
      
      - name: Run Fraud Detection
        continue-on-error: true
        run: |
          cd src
          python trier_fraud_detector.py
          python trier_dashboard.py
      
      - name: Fetch OZON Real Data
        continue-on-error: true
        env:
          OZON_CLIENT_ID: ${{ secrets.OZON_CLIENT_ID }}
          OZON_API_KEY: ${{ secrets.OZON_API_KEY }}
        run: |
          cd src
          if [ -f "ozon_dashboard_data.py" ]; then
            python ozon_dashboard_data.py
          else
            echo "OZON script not found - skipping"
          fi
      
      - name: Update Music Dashboard
        continue-on-error: true
        run: |
          cd src
          if [ -f "music_dashboard.py" ]; then
            python music_dashboard.py
          fi
      
      - name: Commit all changes
        run: |
          git config --local user.email "trier-bot@github.com"
          git config --local user.name "TRIER Bot"
          git add data/ real_data/ music/ docs/
          git diff --quiet && git diff --staged --quiet || git commit -m "ðŸ¤– TRIER update $(date +'%Y-%m-%d %H:%M')"
          git push
