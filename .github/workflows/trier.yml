name: TRIER Unified Workflow

on:
  schedule:
    - cron: '*/30 * * * *'
  workflow_dispatch:

jobs:
  trier:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'
      
      - name: Install dependencies
        run: pip install requests pandas numpy
      
      - name: Prepare directories
        run: |
          mkdir -p real_data/ozon data music docs
      
      - name: Run Fraud Detection
        continue-on-error: true
        run: |
          cd src
          python trier_fraud_detector.py
          python trier_dashboard.py
      
      - name: Fetch OZON Real Data
        continue-on-error: true
        env:
          OZON_CLIENT_ID: ${{ secrets.OZON_CLIENT_ID }}
          OZON_API_KEY: ${{ secrets.OZON_API_KEY }}
        run: |
          cd src
          [ -f "ozon_dashboard_data.py" ] && python ozon_dashboard_data.py
      
      - name: Update Music Dashboard
        continue-on-error: true
        run: |
          cd src
          [ -f "music_dashboard.py" ] && python music_dashboard.py
      
      - name: üîÑ SYNC INDEX.HTML WITH RUSSO.HTML STRUCTURE
        run: |
          echo "üîÑ Syncing index.html to match russo.html structure with ENGLISH content..."
          
          # Check if russo.html exists
          if [ ! -f "docs/russo.html" ]; then
            echo "‚ö†Ô∏è russo.html not found, creating placeholder"
            echo '<!DOCTYPE html><html><head><title>TRIER - English</title></head><body><h1>TRIER Fraud Detection</h1><p>English version</p><a href="russo.html">üá∑üá∫ –†—É—Å—Å–∫–∏–π</a></body></html>' > docs/russo.html
          fi
          
          # Create ENGLISH index.html that MATCHES structure of russo.html
          python - <<EOF
          import re
          
          # Read Russian version
          with open('docs/russo.html', 'r') as f:
              russian = f.read()
          
          # Replace Russian text with English equivalents
          # This is a simple example - expand based on your actual content
          english = russian
          
          # Title and headers
          english = english.replace('–û—Ä–∏–µ–Ω—Ç–∞–ª—å–Ω—ã–π –¥–µ—Ç–µ–∫—Ç–æ—Ä –º–æ—à–µ–Ω–Ω–∏—á–µ—Å—Ç–≤–∞', 'Oriental Fraud Detector')
          english = english.replace('–ü–æ—Å–ª–µ–¥–Ω–µ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ', 'Last updated')
          english = english.replace('–§–æ–∫—É—Å:', 'Focus:')
          english = english.replace('–†–æ—Å—Å–∏–π—Å–∫–∏–µ –ø–∞—Ç—Ç–µ—Ä–Ω—ã', 'Russian Patterns')
          english = english.replace('–ö–∏—Ç–∞–π—Å–∫–∏–µ –ø–∞—Ç—Ç–µ—Ä–Ω—ã', 'Chinese Patterns')
          english = english.replace('–í—ã—Å–æ–∫–æ—Ä–∏—Å–∫–æ–≤—ã–µ –∞–ª–µ—Ä—Ç—ã', 'High Risk Alerts')
          english = english.replace('–¢—Ä–∞–Ω–∑–∞–∫—Ü–∏—è', 'Transaction')
          english = english.replace('–ú–∞–≥–∞–∑–∏–Ω', 'Merchant')
          english = english.replace('–õ–æ–∫–∞—Ü–∏—è', 'Location')
          english = english.replace('–°—É–º–º–∞', 'Amount')
          english = english.replace('–†–∏—Å–∫', 'Risk')
          
          # Language switcher
          english = english.replace('href="index.html"', 'href="russo.html"')
          english = english.replace('üá∑üá∫ –†—É—Å—Å–∫–∏–π', 'üá¨üáß English')
          
          # Write English version
          with open('docs/index.html', 'w') as f:
              f.write(english)
          
          print("‚úÖ index.html created with ENGLISH content matching russo.html structure")
          EOF
          
          echo "üìä Files in docs/:"
          ls -la docs/
      
      - name: Commit all changes
        run: |
          git config --local user.email "trier-bot@github.com"
          git config --local user.name "TRIER Bot"
          git add data/ real_data/ music/ docs/
          git diff --quiet && git diff --staged --quiet || git commit -m "ü§ñ TRIER update $(date +'%Y-%m-%d %H:%M')"
          git push
